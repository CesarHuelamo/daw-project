!function(e){var t={};function r(o){if(t[o])return t[o].exports;var s=t[o]={i:o,l:!1,exports:{}};return e[o].call(s.exports,s,s.exports,r),s.l=!0,s.exports}r.m=e,r.c=t,r.d=function(e,t,o){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:o})},r.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=18)}([function(e,t){e.exports=require("react")},function(e,t){e.exports=require("react-router-dom")},function(e,t){e.exports=require("mongoose")},function(e,t,r){"use strict";var o=r(1),s=r(5),n=r.n(s),a=r(0),i=r.n(a);class l extends i.a.Component{render(){return i.a.createElement("form",{method:"POST",action:"/login"},i.a.createElement("div",{className:"centered-form"},i.a.createElement("h3",null,"JavasQuizz"),i.a.createElement("div",{className:"form-field"},i.a.createElement("label",{htmlFor:"room"},"Email",i.a.createElement("input",{type:"text",name:"email",autoComplete:"off",required:!0}))),i.a.createElement("div",{className:"form-field"},i.a.createElement("label",{htmlFor:"room"},"Contraseña",i.a.createElement("input",{type:"password",name:"password",autoComplete:"off",required:!0}))),i.a.createElement("div",{id:"entrar",className:"form-field"},i.a.createElement("input",{type:"submit",value:"Entrar"})),i.a.createElement(o.Link,{to:"/sign-in"},"Registrate")))}}class c extends i.a.Component{render(){return i.a.createElement("form",{action:"/users",method:"POST"},i.a.createElement("div",{className:"centered-form"},i.a.createElement("h3",null,"JavasQuizz"),i.a.createElement("div",{className:"form-field"},i.a.createElement("label",{htmlFor:"room"},"Email",i.a.createElement("input",{type:"email",name:"email",autoComplete:"off",required:!0}))),i.a.createElement("div",{className:"form-field"},i.a.createElement("label",{htmlFor:"room"},"Nick",i.a.createElement("input",{type:"text",name:"nick",autoComplete:"off",required:!0}))),i.a.createElement("div",{className:"form-field"},i.a.createElement("label",{htmlFor:"room"},"Contraseña",i.a.createElement("input",{type:"password",name:"password",autoComplete:"off",required:!0}))),i.a.createElement("div",{id:"entrar",className:"form-field"},i.a.createElement("input",{type:"submit",value:"Enviar"})),i.a.createElement("a",{href:"/"},"¿Ya estás registrado?")))}}class m extends i.a.Component{render(){return i.a.createElement("form",{action:"/rooms",method:"POST"},i.a.createElement("div",{className:"centered-form"},i.a.createElement("h3",null,"JavasQuizz"),i.a.createElement("div",{className:"form-field"},i.a.createElement("label",{htmlFor:"room"},"Nombre de la sala",i.a.createElement("input",{type:"text",name:"room",autoComplete:"off",required:!0}))),i.a.createElement("div",{id:"entrar",className:"form-field"},i.a.createElement("input",{type:"submit",value:"Entrar"}))))}}var u=r(6),p=r.n(u);class d extends i.a.Component{constructor(e){super(e),this.state={},this.connected=i.a.createRef(),this.correct=i.a.createRef(),this.disconnected=i.a.createRef(),this.userJoin=i.a.createRef()}componentDidMount(){const e=this.connected.current,t=(this.correct.current,this.disconnected.current,this.userJoin.current,p()());t.on("connect",()=>{e.play()}),t.on("start",e=>{document.title=`Sala ${e.room} | JavasQuizz`;let t=e.users.map(t=>({nick:t,color:e.userColors[t],score:0}));this.setState({colors:e.userColors,room:e.room,user:e.user,players:t})})}render(){return[i.a.createElement("header",null,i.a.createElement("h1",null,"JavasQuizz"),i.a.createElement("h3",null,"Sala ",this.state.room,i.a.createElement("span",{id:"sala"}))),i.a.createElement("main",null,i.a.createElement("aside",null,i.a.createElement("h3",null,"Jugadores"),i.a.createElement("ul",null)),i.a.createElement("section",null,i.a.createElement("div",null,"La partida empieza en...",i.a.createElement("br",null),i.a.createElement("span",{id:"starting"}),i.a.createElement("h2",{class:"finalScoreTitle",style:{display:"none"}},"Puntuación final")),i.a.createElement("div",{id:"info"},i.a.createElement("p",null,"Tiempo restante: ",i.a.createElement("span",{id:"timer"})),i.a.createElement("div",{id:"pregunta"})),i.a.createElement("div",{id:"chat"}),i.a.createElement("form",{id:"message-form"},i.a.createElement("input",{type:"text",name:"message",autoComplete:"off"}),i.a.createElement("input",{type:"submit"}))),i.a.createElement("audio",{src:"correct.mp3",ref:this.correct}),i.a.createElement("audio",{src:"connected.wav",ref:this.connected}),i.a.createElement("audio",{src:"disconnected.wav",ref:this.disconnected}),i.a.createElement("audio",{src:"userJoin.wav",ref:this.userJoin}))]}}class f extends i.a.Component{render(){return i.a.createElement("div",{id:"root"},i.a.createElement(o.Route,{exact:!0,path:"/",component:l}),i.a.createElement(o.Route,{path:"/log-in",component:l}),i.a.createElement(o.Route,{path:"/sign-in",component:c}),i.a.createElement(o.Route,{path:"/join-room",component:m}),i.a.createElement(o.Route,{path:"/room",component:d}))}}function _(e,t){return n.a.renderToString(i.a.createElement(o.StaticRouter,{location:e,context:t},i.a.createElement(f,null)))}function h(e){return`\n    <html>\n    <head>\n        <meta charset="utf-8" />\n        <meta http-equiv="X-UA-Compatible" content="IE=edge" />\n        <title>Join | JavasQuizz</title>\n        <meta name="viewport" content="width=device-width, initial-scale=1" />\n        <link href="https://fonts.googleapis.com/css?family=Fredoka+One" rel="stylesheet" />\n        <link href="https://fonts.googleapis.com/css?family=Kaushan+Script" rel="stylesheet" />\n        <link href="https://fonts.googleapis.com/css?family=Fira+Sans" rel="stylesheet" />\n        <link type="text/css" rel="stylesheet" href="css/styles.css" />\n    </head>\n    <body>\n        ${e}\n    </body>\n    <script src="js/bundle.js"><\/script>\n    </html>`}r.d(t,"b",function(){return _}),r.d(t,"a",function(){return h})},function(e,t){e.exports=require("validator")},function(e,t){e.exports=require("react-dom/server")},function(e,t){e.exports=require("socket.io-client")},function(e,t){e.exports=require("crypto-js/sha256")},function(e,t){e.exports=require("jsonwebtoken")},function(e,t){e.exports=require("express-session")},function(e,t,r){const o=r(2);r(4);var s=new o.Schema({question:{type:String,required:!0},answer:{type:String,required:!0},eval:{type:Array,required:!0}});let n=o.model("Question",s);e.exports={Question:n}},function(e,t,r){const o=r(2),s=r(4);var n=new o.Schema({email:{type:String,required:!0,unique:!0,trim:!0,minlength:1,validate:{validator:s.isEmail,message:"{VALUE} is not a valid email"}},nick:{type:String,require:!0,unique:!0,trim:!0,minLength:1},password:{type:String,required:!0,minLength:8}});let a=o.model("User",n);e.exports={User:a}},function(e,t,r){"use strict";const o=r(2);o.Promise=global.Promise,o.connect("mongodb://localhost:27017/Javasquizz"),e.exports={mongoose:o}},function(e,t){e.exports=require("lodash")},function(e,t){e.exports=require("socket.io")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("path")},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _html__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(3);const path=__webpack_require__(17),http=__webpack_require__(16),express=__webpack_require__(15),socketIO=__webpack_require__(14),_=__webpack_require__(13),{mongoose:mongoose}=__webpack_require__(12),{User:User}=__webpack_require__(11),{Question:Question}=__webpack_require__(10),session=__webpack_require__(9),jwt=__webpack_require__(8),SHA256=__webpack_require__(7),publicPath=path.join(__dirname,"/../public");let app=express(),server=http.createServer(app),io=socketIO(server);app.use(express.static(publicPath)),app.set("view engine","html"),app.use(express.urlencoded({extended:!0})),app.use(express.json()),app.use(session({secret:"layla",resave:!1,saveUninitialized:!0,cookie:{expires:6e9,userid:null}}));const port=process.env.PORT||8080;let users={};const questions=[{question:"typeof 12",answer:"number",eval:[!1]},{question:'typeof "hola"',answer:"string",eval:[!1]},{question:"Rellena el hueco con la función adecuada: <br/>[2,3]._______.((v,i,a) => {return v+2;}); <br/> resultado: [4,5]",answer:"[4,5]",eval:[!0,"[2,3].","((v) => {return v+2});"]},{question:"typeof [12]",answer:"object",eval:[!1]}],colors=["yellow","green","lightred","lightblue","black","white","orange"];let color,userColors={},rooms={},room,user;function tenRandomNumbers(){let e=[];for(;e.length<10;){let t=Math.round(20*Math.random());-1==e.indexOf(t)&&e.push(t)}return e}function newQuestion(e){console.log(rooms[e].users,rooms[e].timer),clearInterval(rooms[e].interval),clearTimeout(rooms[e].timeout),rooms[e].timer=60,io.sockets.in(e).emit("timer",rooms[e].timer),rooms[e].interval=setInterval(()=>{rooms[e].timer<=0||rooms[e].timer--},1e3),rooms[e].timeout=setTimeout(()=>{newQuestion(e)},63e3),rooms[e].responses=0,0==rooms[e].questions.length?final(e):(rooms[e].currentQuestion=rooms[e].questions.splice(0,1)[0],io.sockets.in(e).emit("question",rooms[e].currentQuestion))}function final(e){rooms[e].start="finished",rooms[e].questions=questions.slice(),rooms[e].timer=60,io.sockets.in(e).emit("final",{timer:rooms[e].timer,score:rooms[e].users}),clearInterval(rooms[e].interval),rooms[e].interval=setInterval(()=>{rooms[e].timer<=0||rooms[e].timer--},1e3),rooms[e].timeout=setTimeout(()=>{Object.keys(rooms[e].users).forEach(t=>{rooms[e].users[t]=0}),newQuestion(e),rooms[e].start=!0},6e4)}app.post("/session",(e,t)=>{User.findOne({token:e.body.token}).then(e=>{t.send({nick:e.nick})}).catch(()=>{t.send(!1)})}),app.get("*",(e,t)=>{e.session.user||"/sign-in"===e.url||"/log-in"===e.url||t.redirect("/log-in"),e.session.user&&"/join-room"!==e.url&&"/room"!==e.url&&t.redirect("/join-room");let r=Object(_html__WEBPACK_IMPORTED_MODULE_0__.a)(Object(_html__WEBPACK_IMPORTED_MODULE_0__.b)(e.url,{}));t.write(r),t.end()}),app.post("/users",(e,t)=>{let r=_.pick(e.body,["email","password","nick"]);r.password=SHA256(r.password+"layla"),new User(r).save().then(()=>{e.session.user=r.nick,t.send("/join-room")}).catch(e=>{t.status(400).send(e)})}),app.post("/login",(e,t)=>{let r=_.pick(e.body,["email","password"]);r.password=SHA256(r.password+"layla").toString(),console.log(r),User.findOne(r).then(r=>{r?(e.session.user=r.nick,t.redirect("/join-room")):t.send(!1)}).catch(e=>console.log(e))}),app.post("/rooms",(e,t)=>{if(room=e.body.room,user=e.session.user,!rooms[room]){rooms[e.body.room]={start:!1,users:{},timer:60,responses:0,questions:[],currentQuestion:null,interval:null,timeout:null};let t=[3,2,1];Question.find().then(e=>{t.forEach(t=>{console.log(e[t]),rooms[room].questions.push(e[t])})})}for(let t=0;t<10;t++)rooms[room].users[user]>-1&&(console.log(user),user=`${e.body.user}(${t})`);Object.keys(rooms[room].users).length<10?(rooms[room].users[user]=0,t.redirect("/room")):t.sendFile(publicPath+"/sala-llena.html"),color=colors[Math.floor(7*Math.random())],userColors[user]=color}),io.on("connection",socket=>{socket.join(room),socket.emit("start",{room:room,user:user,users:Object.keys(rooms[room].users),userColors:userColors}),io.sockets.in(room).emit("newPlayer",{user:user,color:color}),rooms[room].start?"finished"===rooms[room].start?socket.emit("final",{timer:rooms[room].timer,score:rooms[room].users}):(socket.emit("question",rooms[room].currentQuestion),socket.emit("timer",rooms[room].timer)):(rooms[room].interval=setInterval(()=>{rooms[room].timer--},1e3),io.sockets.in(room).emit("starting",rooms[room].timer),newQuestion(room),rooms[room].start=!0),console.log("New user connected"),socket.on("response",data=>{let answer=data.body,currentRoom=rooms[data.room];if(currentRoom.currentQuestion.eval[0])try{answer=JSON.stringify(eval(currentRoom.currentQuestion.eval[1]+answer+currentRoom.currentQuestion.eval[2]))}catch(e){answer=null}if(answer==currentRoom.currentQuestion.answer){if(data.responded)return;currentRoom.users[data.user]+=currentRoom.timer,currentRoom.responses++,io.sockets.in(data.room).emit("correct",{user:data.user,questionScore:currentRoom.timer,totalScore:currentRoom.users[data.user]})}else io.sockets.in(data.room).emit("newMessage",{user:data.user,body:data.body});currentRoom.responses==Object.keys(currentRoom.users).length&&newQuestion(data.room)}),socket.on("createMessage",e=>{io.sockets.in(e.room).emit("newMessage",{user:e.user,body:e.body})}),socket.on("exit",e=>{delete rooms[e.room].users[e.user],console.log(rooms),0===Object.keys(rooms[e.room].users).length&&(clearInterval(rooms[e.room].interval),clearTimeout(rooms[e.room].timeout),delete rooms[e.room]),io.sockets.in(e.room).emit("playerExit",e.user),console.log(rooms)})}),server.listen(port,()=>{console.log("server up in port "+port)})}]);